<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专业数据核算系统 - 优化数据处理流程</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- 初始化提示 -->
    <div id="initMessage" class="init-message">
        <div style="text-align: center;">
            <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 15px;"></div>
            <p>正在初始化优化数据处理系统...</p>
        </div>
    </div>

    <!-- 加载动画 -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div id="loaderMessage" style="color: white; margin-top: 20px;"></div>
        <div id="loaderProgress" style="width: 300px; margin-top: 20px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden;">
            <div style="height: 6px; background: #3498db; width: 0%; transition: width 0.3s;" id="loaderProgressBar"></div>
        </div>
    </div>

    <!-- Web Worker 状态 -->
    <div id="workerStatus" class="status-message info" style="display: none; bottom: 70px;">
        <i class="fas fa-microchip"></i> 后台处理中... <span id="workerMessage"></span>
    </div>

    <!-- 状态提示 -->
    <div id="statusMessage" class="status-message"></div>

    <!-- 模态框 -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0; color: #2c3e50;" id="modalTitle"></h3>
                <button class="btn-close" onclick="closeModal()" title="关闭">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- 空白行处理模态框 -->
    <div class="blank-row-modal" id="blankRowModal">
        <div class="blank-row-modal-content">
            <div class="blank-row-header">
                <h3 style="margin: 0; color: #856404;">
                    <i class="fas fa-exclamation-triangle"></i> 发现空白Transaction Type
                </h3>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem;">
                    共有 <span id="blankRowsCount">0</span> 行Transaction Type为空的数据，请为这些数据分配一级分类：
                </p>
            </div>
            
            <div class="blank-row-body">
                <div style="margin-bottom: 15px; color: #7f8c8d;">
                    <i class="fas fa-info-circle"></i> 请为以下每行数据选择一个一级分类。选择"忽略"的行将不计入汇总统计。
                </div>
                
                <div id="blankRowsContainer" class="virtual-scroll-container" style="height: 400px;">
                    <!-- 虚拟滚动容器 -->
                </div>
            </div>
            
            <div class="blank-row-footer">
                <button class="tool-btn" onclick="ui.applyBlankRowAssignments()" style="padding: 10px 20px; background: #27ae60; color: white;">
                    <i class="fas fa-check"></i> 应用分配
                </button>
                <button class="tool-btn" onclick="ui.closeBlankRowModal()" style="padding: 10px 20px; margin-left: 10px;">
                    <i class="fas fa-times"></i> 取消
                </button>
            </div>
        </div>
    </div>

    <!-- 字段定义模态框（优化版） -->
    <div class="field-definition-modal" id="fieldDefinitionModal">
        <div class="field-definition-modal-content">
            <div class="field-definition-header">
                <h3 style="margin: 0; color: #2c3e50;">
                    <i class="fas fa-cogs"></i> 字段映射定义 - 优化版
                </h3>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem;">
                    分页加载 + 虚拟滚动 + 智能索引 (共 <span id="fieldMappingCount">0</span> 个字段)
                </p>
            </div>
            
            <div class="field-definition-body">
                <!-- 搜索和筛选区域 -->
                <div class="field-search-container">
                    <input type="text" id="fieldSearchInput" class="field-search-input" 
                           placeholder="搜索Transaction Description..." 
                           oninput="ui.searchFieldMappings()">
                    <select id="categoryFilterSelect" class="field-search-input" style="width: 200px;"
                            onchange="ui.filterFieldMappingsByCategory()">
                        <option value="">所有分类</option>
                        <option value="销售额">销售额</option>
                        <option value="广告费">广告费</option>
                        <option value="平台佣金">平台佣金</option>
                        <option value="仓储费用">仓储费用</option>
                        <option value="产品成本">产品成本</option>
                        <option value="退货费用">退货费用</option>
                        <option value="测评费用">测评费用</option>
                        <option value="物流费">物流费</option>
                        <option value="__ignore__">忽略</option>
                    </select>
                    <button class="tool-btn" onclick="ui.clearFieldMappingFilters()" style="padding: 8px 12px;">
                        <i class="fas fa-times"></i> 清除筛选
                    </button>
                </div>
                
                <!-- 一级分类定义区域 -->
                <div class="category-definition-container">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">
                        <i class="fas fa-list"></i> 一级分类（固定8类）
                    </h4>
                    <div id="primaryCategoriesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                        <!-- 一级分类将动态生成 -->
                    </div>
                </div>
                
                <!-- 字段映射表格 - 使用虚拟滚动 -->
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">
                        <i class="fas fa-table"></i> 字段映射表
                        <span id="virtualScrollInfo" style="font-size: 0.9rem; color: #7f8c8d; margin-left: 10px;">
                            （虚拟滚动 - 流畅处理大数据）
                        </span>
                    </h4>
                    
                    <div id="fieldMappingScrollContainer" class="virtual-scroll-container" style="height: 400px;">
                        <!-- 虚拟滚动内容 -->
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="pagination-controls">
                        <button class="page-btn" onclick="ui.prevFieldMappingPage()" id="prevPageBtn" disabled>
                            <i class="fas fa-chevron-left"></i> 上一页
                        </button>
                        <span id="pageInfo">第1页 / 共1页</span>
                        <button class="page-btn" onclick="ui.nextFieldMappingPage()" id="nextPageBtn" disabled>
                            下一页 <i class="fas fa-chevron-right"></i>
                        </button>
                        <select id="pageSizeSelect" onchange="ui.changePageSize(this.value)" style="margin-left: 20px; padding: 6px;">
                            <option value="50">50行/页</option>
                            <option value="100" selected>100行/页</option>
                            <option value="200">200行/页</option>
                            <option value="500">500行/页</option>
                        </select>
                    </div>
                </div>
                
                <!-- 批量操作区域 -->
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h5 style="margin-bottom: 10px; color: #2c3e50;">批量操作</h5>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="tool-btn" onclick="ui.downloadFieldMappingTemplate()" style="padding: 8px 16px; background: #3498db; color: white;">
                            <i class="fas fa-download"></i> 下载映射模板
                        </button>
                        <button class="tool-btn" onclick="document.getElementById('uploadMappingFile').click()" style="padding: 8px 16px;">
                            <i class="fas fa-upload"></i> 上传映射文件
                        </button>
                        <input type="file" id="uploadMappingFile" accept=".xlsx,.xls,.csv" style="display: none;" onchange="ui.handleMappingFileUpload(this.files)">
                        <button class="tool-btn" onclick="ui.batchAssignPrimaryCategory()" style="padding: 8px 16px; background: #27ae60; color: white;">
                            <i class="fas fa-bolt"></i> 批量分配
                        </button>
                        <button class="tool-btn" onclick="ui.autoMapFields()" style="padding: 8px 16px; background: #9b59b6; color: white;">
                            <i class="fas fa-magic"></i> 智能匹配
                        </button>
                        <button class="tool-btn" onclick="ui.autoMapSimilarDescriptions()" style="padding: 8px 16px; background: #e67e22; color: white;">
                            <i class="fas fa-broom"></i> 相同描述一键分配
                        </button>
                        <button class="tool-btn" onclick="ui.compactMappings()" style="padding: 8px 16px; background: #2c3e50; color: white;">
                            <i class="fas fa-compress"></i> 压缩映射
                        </button>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #7f8c8d;">
                        <i class="fas fa-lightbulb"></i> 提示：使用虚拟滚动和分页加载，可流畅处理数万行数据
                    </div>
                </div>
            </div>
            
            <div class="field-definition-footer">
                <button class="tool-btn btn-back" onclick="ui.closeFieldDefinitionModal(true)" style="padding: 10px 20px;">
                    <i class="fas fa-arrow-left"></i> 返回上一步
                </button>
                <button class="tool-btn" onclick="ui.saveFieldMappings()" style="padding: 10px 20px; background: #27ae60; color: white;">
                    <i class="fas fa-save"></i> 保存映射定义
                </button>
                <button class="tool-btn" onclick="ui.skipFieldMapping()" style="padding: 10px 20px; margin-left: 10px;">
                    <i class="fas fa-forward"></i> 跳过映射
                </button>
                <button class="tool-btn" onclick="ui.closeFieldDefinitionModal()" style="padding: 10px 20px; margin-left: 10px;">
                    <i class="fas fa-times"></i> 取消
                </button>
            </div>
        </div>
    </div>

    <!-- 主应用容器 -->
    <div class="app-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-calculator"></i> 数据核算系统</h1>
                <small style="color: #3498db; font-size: 0.8rem;">优化版</small>
            </div>
            
            <div class="nav-menu">
                <div class="nav-item active" onclick="showPanel('upload')">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>数据上传</span>
                    <span id="uploadBadge" class="badge" style="display: none;">流式</span>
                </div>
                <div class="nav-item" onclick="showPanel('tables')">
                    <i class="fas fa-table"></i>
                    <span>数据表管理</span>
                    <span id="tableCount" class="badge">0</span>
                </div>
                <div class="nav-item" onclick="showPanel('process')">
                    <i class="fas fa-cogs"></i>
                    <span>数据处理</span>
                </div>
                <div class="nav-item" onclick="showPanel('merge')">
                    <i class="fas fa-object-group"></i>
                    <span>账单汇总与核算</span>
                    <span id="optimizeBadge" class="badge" style="background: #27ae60;">优化</span>
                </div>
                <div class="nav-item" onclick="showPanel('performance')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>性能监控</span>
                </div>
            </div>
            
            <div class="system-status">
                <div style="padding: 15px; font-size: 0.85rem; color: #7f8c8d;">
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <i class="fas fa-microchip" style="margin-right: 8px;"></i>
                        <span>处理引擎: <span id="engineStatus">就绪</span></span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-memory" style="margin-right: 8px;"></i>
                        <span>内存: <span id="memoryUsage">--</span></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 上传面板 -->
            <div id="uploadPanel" class="content-panel active">
                <div class="panel-header">
                    <h2><i class="fas fa-cloud-upload-alt"></i> 数据上传 - 流式处理</h2>
                    <div style="font-size: 0.9rem; color: #3498db; margin-top: 5px;">
                        <i class="fas fa-bolt"></i> 支持大文件流式解析，不卡顿
                    </div>
                </div>
                
                <div class="upload-container">
                    <!-- 文件上传区域 -->
                    <div class="upload-box" id="uploadDropArea" onclick="document.getElementById('fileInput').click();">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <h3>点击或拖放文件到此处</h3>
                            <p>支持 .xlsx, .xls, .csv, .zip 格式 - 流式处理大文件</p>
                            <div id="progressContainer" style="display: none;">
                                <div class="progress-bar" id="progressBar"></div>
                                <div id="progressDetails" style="margin-top: 5px; font-size: 0.85rem; color: #7f8c8d;">
                                    <span id="progressText">正在解析...</span>
                                    <span id="chunkInfo" style="float: right;"></span>
                                </div>
                            </div>
                        </div>
                        <div class="upload-formats">
                            <span class="format-tag"><i class="fas fa-bolt"></i> .xlsx (流式)</span>
                            <span class="format-tag">.xls</span>
                            <span class="format-tag">.csv</span>
                            <span class="format-tag">.zip</span>
                        </div>
                    </div>
                    
                    <!-- 上传选项 -->
                    <div class="config-panel" style="margin-top: 20px;">
                        <h4 style="margin-bottom: 15px; color: #2c3e50;">
                            <i class="fas fa-sliders-h"></i> 处理选项
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label>
                                    <input type="checkbox" id="useStreaming" checked>
                                    启用流式解析
                                </label>
                                <div style="font-size: 0.85rem; color: #7f8c8d;">
                                    分块读取大文件，避免内存溢出
                                </div>
                            </div>
                            <div>
                                <label>
                                    <input type="checkbox" id="useWebWorker" checked>
                                    启用Web Worker
                                </label>
                                <div style="font-size: 0.85rem; color: #7f8c8d;">
                                    后台处理，不阻塞界面
                                </div>
                            </div>
                            <div>
                                <label>
                                    <input type="checkbox" id="compressData" checked>
                                    启用数据压缩
                                </label>
                                <div style="font-size: 0.85rem; color: #7f8c8d;">
                                    减少内存占用
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <label>流式分块大小：</label>
                            <select id="chunkSizeSelect" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="500">500行/块</option>
                                <option value="1000" selected>1000行/块</option>
                                <option value="2000">2000行/块</option>
                                <option value="5000">5000行/块</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="info-panel" style="margin-top: 30px;">
                        <h4><i class="fas fa-info-circle"></i> 优化说明：</h4>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li><strong>流式解析</strong>：大文件分块读取，边读边处理，不等待全部完成</li>
                            <li><strong>Web Worker</strong>：后台处理，界面不卡顿</li>
                            <li><strong>内存优化</strong>：只保留必要字段，处理完立即释放内存</li>
                            <li><strong>分块处理</strong>：每次处理1000行，避免内存溢出</li>
                            <li><strong>智能识别</strong>：系统会自动识别文件类型并优化处理</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 数据表管理面板 -->
            <div id="tablesPanel" class="content-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-table"></i> 数据表管理</h2>
                </div>
                
                <div style="padding: 30px;">
                    <div class="info-panel">
                        <h4><i class="fas fa-info-circle"></i> 表格管理</h4>
                        <p>所有已上传和处理的数据表格都显示在这里。您可以预览、导出或删除表格。</p>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="tool-btn" onclick="ui.compactAllTables()" style="padding: 8px 16px;">
                                <i class="fas fa-compress"></i> 压缩所有表格
                            </button>
                            <button class="tool-btn" onclick="ui.exportAllTables()" style="padding: 8px 16px;">
                                <i class="fas fa-download"></i> 批量导出
                            </button>
                            <button class="tool-btn" onclick="ui.clearAllTables()" style="padding: 8px 16px; background: #e74c3c; color: white;">
                                <i class="fas fa-trash"></i> 清空所有
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-list" id="tableListContainer">
                        <!-- 表格卡片动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 数据处理面板 -->
            <div id="processPanel" class="content-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-cogs"></i> 数据处理</h2>
                </div>
                
                <div style="padding: 30px;">
                    <!-- 第一步：数据筛选 -->
                    <div class="process-step">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <h3>数据筛选</h3>
                        </div>
                        <p>选择要处理的表格，筛选出需要的字段</p>
                        <select id="filterTableSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin: 10px 0;">
                            <option value="">请选择要筛选的数据表</option>
                        </select>
                        
                        <div id="columnSelectorContainer" style="display: none;">
                            <h4>选择要保留的字段：</h4>
                            <div class="column-selector" id="columnSelector">
                                <!-- 字段选择器动态生成 -->
                            </div>
                            <div style="margin-top: 15px;">
                                <button class="tool-btn" onclick="ui.filterData()" style="padding: 10px 20px;">
                                    <i class="fas fa-filter"></i> 筛选数据
                                </button>
                                <button class="tool-btn" onclick="ui.selectAllColumns()" style="padding: 10px 20px; margin-left: 10px;">
                                    <i class="fas fa-check-square"></i> 全选
                                </button>
                                <button class="tool-btn" onclick="ui.deselectAllColumns()" style="padding: 10px 20px; margin-left: 10px;">
                                    <i class="fas fa-square"></i> 全不选
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第二步：智能账单合并 -->
                    <div class="process-step" style="border-left-color: #27ae60;">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <h3>智能账单合并</h3>
                        </div>
                        <p>选择要合并的账单表格，系统会按照Transaction Key字段智能合并</p>
                        
                        <div class="bill-list-container" id="billListContainer">
                            <!-- 账单列表动态生成 -->
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="tool-btn" onclick="ui.mergeBillTables()" style="padding: 10px 20px; background: #27ae60; color: white;">
                                <i class="fas fa-layer-group"></i> 开始智能合并
                            </button>
                            <button class="tool-btn" onclick="ui.selectAllBills()" style="padding: 10px 20px; margin-left: 10px;">
                                <i class="fas fa-check-square"></i> 全选账单
                            </button>
                        </div>
                    </div>
                    
                    <!-- 第三步：VLOOKUP式订单时间匹配 -->
                    <div class="process-step" style="border-left-color: #9b59b6;">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <h3>VLOOKUP式订单时间匹配</h3>
                        </div>
                        <p>使用速猫订单表匹配账单汇总表中的Purchase Order #，生成下单时间匹配表</p>
                        
                        <!-- 简化的匹配配置 -->
                        <div class="config-panel">
                            <div class="config-title">
                                <i class="fas fa-search"></i>
                                <span>速猫订单表配置</span>
                            </div>
                            <div class="config-item">
                                <label for="orderTableSelect">选择速猫订单表：</label>
                                <select id="orderTableSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="ui.onOrderTableChange()">
                                    <option value="">请选择速猫订单表</option>
                                </select>
                            </div>
                            
                            <div class="config-item" style="margin-top: 10px;">
                                <label for="orderNumberSelect">订单号字段：</label>
                                <select id="orderNumberSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">请先选择速猫订单表</option>
                                </select>
                            </div>
                            
                            <div class="config-item" style="margin-top: 10px;">
                                <label for="orderTimeSelect">下单时间字段：</label>
                                <select id="orderTimeSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">请先选择速猫订单表</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="config-panel">
                            <div class="config-title">
                                <i class="fas fa-file-invoice"></i>
                                <span>账单汇总表配置</span>
                            </div>
                            <div class="config-item">
                                <label for="billTableSelect">选择账单汇总表：</label>
                                <select id="billTableSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="ui.onBillTableChange()">
                                    <option value="">请选择账单汇总表</option>
                                </select>
                            </div>
                            
                            <div class="config-item" style="margin-top: 10px;">
                                <label for="purchaseOrderSelect">Purchase Order #字段：</label>
                                <select id="purchaseOrderSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">请先选择账单汇总表</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 匹配流程图 -->
                        <div class="match-flow">
                            <h5><i class="fas fa-lightbulb"></i> 优化匹配逻辑：</h5>
                            <ol>
                                <li><strong>构建哈希索引</strong>：使用Map建立订单号→下单时间的O(1)查找</li>
                                <li><strong>批量匹配</strong>：按Purchase Order #分组批量处理</li>
                                <li><strong>流式生成</strong>：边匹配边生成结果，不等待全部完成</li>
                                <li><strong>异步处理</strong>：大文件在Web Worker中处理</li>
                            </ol>
                        </div>
                        
                        <!-- 匹配控制 -->
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="tool-btn" onclick="ui.performVlookupMatch()" style="padding: 10px 20px; background: #9b59b6; color: white; flex: 1;">
                                <i class="fas fa-exchange-alt"></i> 开始优化匹配
                            </button>
                            <button class="tool-btn" onclick="ui.resetVlookupConfig()" style="padding: 10px 20px;">
                                <i class="fas fa-redo"></i> 重置配置
                            </button>
                        </div>
                    </div>
                    
                    <!-- 第四步：将匹配结果合并到账单汇总表 -->
                    <div class="process-step" style="border-left-color: #e67e22;">
                        <div class="step-header">
                            <div class="step-number">4</div>
                            <h3>合并下单时间到账单汇总表</h3>
                        </div>
                        <p>将第三步生成的匹配结果合并到账单汇总表，下单时间添加到第一列</p>
                        
                        <div style="margin: 15px 0;">
                            <select id="billTableForMergeSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">请选择要合并下单时间的账单汇总表</option>
                            </select>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <select id="matchTableForMergeSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">请选择下单时间匹配表</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="tool-btn" onclick="ui.mergeMatchedTimeToBill()" style="padding: 10px 20px; background: #e67e22; color: white;">
                                <i class="fas fa-layer-group"></i> 合并下单时间到账单表
                            </button>
                            <button class="tool-btn" onclick="ui.processCompleteWorkflow()" style="padding: 10px 20px; background: #3498db; color: white;">
                                <i class="fas fa-bolt"></i> 一键完成全流程
                            </button>
                        </div>
                        
                        <div class="info-panel" style="margin-top: 15px;">
                            <h4><i class="fas fa-info-circle"></i> 优化处理规则：</h4>
                            <ul style="margin-top: 10px; padding-left: 20px;">
                                <li><strong>增量更新</strong>：只处理新增或修改的数据，避免重复工作</li>
                                <li><strong>批量操作</strong>：按组批量处理，减少重复查找</li>
                                <li><strong>内存回收</strong>：处理完的行立即释放内存引用</li>
                                <li><strong>缓存优化</strong>：编译映射规则为JS函数，提升执行速度</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 账单汇总与核算面板 -->
            <div id="mergePanel" class="content-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-object-group"></i> 账单汇总与核算 - 优化版</h2>
                    <div style="font-size: 0.9rem; color: #27ae60; margin-top: 5px;">
                        <i class="fas fa-tachometer-alt"></i> 分页+虚拟滚动+智能索引，处理速度提升10倍
                    </div>
                </div>
                
                <div style="padding: 30px;">
                    <div class="info-panel">
                        <h4><i class="fas fa-info-circle"></i> 优化版账单汇总与核算</h4>
                        <p>选择"账单订单匹配-新生成"表格，系统将按照以下三步进行数据汇总与核算：</p>
                        <ol style="margin-top: 10px; padding-left: 20px;">
                            <li><strong>第一步：时间筛选</strong> - 按年、月、日筛选数据（流式处理）</li>
                            <li><strong>第二步：字段定义</strong> - 批量定义Transaction Type和Description的含义（分页+虚拟滚动）</li>
                            <li><strong>第三步：数据汇总</strong> - 生成按大类、细分类汇总的金额表格（智能索引）</li>
                        </ol>
                        <div style="margin-top: 15px; padding: 10px; background: #e8f4fc; border-radius: 6px;">
                            <strong>优化特性：</strong>
                            <ul style="margin-top: 5px;">
                                <li>⚡ 分页加载：只加载当前页数据</li>
                                <li>🔄 虚拟滚动：流畅处理万行数据</li>
                                <li>🔍 智能索引：O(1)查找速度</li>
                                <li>🧹 内存优化：TypedArray存储数字</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- 第一步：时间筛选 -->
                    <div class="summary-step" style="border-left-color: #3498db;">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <h3>第一步：时间筛选</h3>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label for="matchedBillTableSelect">选择账单订单匹配表：</label>
                            <select id="matchedBillTableSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 5px;">
                                <option value="">请选择"账单订单匹配-新生成"表格</option>
                            </select>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
                            <h4 style="margin-bottom: 15px; color: #2c3e50;">
                                <i class="fas fa-calendar-alt"></i> 时间筛选条件
                            </h4>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label for="filterYear">筛选年份：</label>
                                    <select id="filterYear" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">请选择年份（可选）</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="filterMonth">筛选月份：</label>
                                    <select id="filterMonth" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">请选择月份（可选）</option>
                                        <option value="1">1月</option>
                                        <option value="2">2月</option>
                                        <option value="3">3月</option>
                                        <option value="4">4月</option>
                                        <option value="5">5月</option>
                                        <option value="6">6月</option>
                                        <option value="7">7月</option>
                                        <option value="8">8月</option>
                                        <option value="9">9月</option>
                                        <option value="10">10月</option>
                                        <option value="11">11月</option>
                                        <option value="12">12月</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="filterDay">筛选日期：</label>
                                    <select id="filterDay" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">请选择日期（可选）</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="color: #7f8c8d; font-size: 0.9rem; margin-top: 10px;">
                                <i class="fas fa-lightbulb"></i> 提示：可以单选、双选或三选筛选条件。如果都不选，将处理所有数据。
                            </div>
                        </div>
                        
                        <div class="summary-controls">
                            <button class="tool-btn" onclick="ui.filterByDate()" style="padding: 10px 20px; background: #3498db; color: white;">
                                <i class="fas fa-filter"></i> 开始筛选
                            </button>
                            <button class="tool-btn" onclick="ui.resetDateFilter()" style="padding: 10px 20px;">
                                <i class="fas fa-redo"></i> 重置筛选
                            </button>
                        </div>
                    </div>
                    
                    <!-- 第二步：字段定义 -->
                    <div class="summary-step" style="border-left-color: #27ae60; display: none;" id="fieldDefinitionStep">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <h3>第二步：字段定义（优化版）</h3>
                        </div>
                        
                        <div id="fieldDefinitionStatus" style="margin: 15px 0;">
                            <!-- 状态信息动态显示 -->
                        </div>
                        
                        <div id="fieldDefinitionControls" style="display: none;">
                            <div style="margin: 15px 0;">
                                <p>已从筛选数据中提取出不重复的字段，请下载定义模板，填写后上传：</p>
                                
                                <div class="summary-controls">
                                    <button class="tool-btn" onclick="ui.downloadFieldDefinitionTemplate()" style="padding: 10px 20px; background: #27ae60; color: white;">
                                        <i class="fas fa-download"></i> 下载定义模板
                                    </button>
                                    <button class="tool-btn" onclick="document.getElementById('fieldDefinitionFile').click()" style="padding: 10px 20px;">
                                        <i class="fas fa-upload"></i> 上传已填写的定义表
                                    </button>
                                    <input type="file" id="fieldDefinitionFile" accept=".xlsx,.xls" style="display: none;" onchange="ui.handleFieldDefinitionUpload(this.files)">
                                </div>
                                
                                <div class="summary-controls" style="margin-top: 15px;">
                                    <button class="tool-btn" onclick="ui.showFieldDefinitionModal()" style="padding: 10px 20px; background: #3498db; color: white;">
                                        <i class="fas fa-table"></i> 在线映射（推荐）
                                    </button>
                                    <button class="tool-btn" onclick="ui.skipFieldDefinition()" style="padding: 10px 20px; background: #95a5a6; color: white;">
                                        <i class="fas fa-forward"></i> 跳过定义
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第三步：数据汇总与核算 -->
                    <div id="dataSummaryStep" class="summary-step" style="border-left-color: #9b59b6; display: block;">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <h3>第三步：数据汇总与核算（优化版）</h3>
                        </div>
                        
                        <!-- 汇总状态 -->
                        <div class="summary-status-container">
                            <div id="summaryInitialStatus" class="summary-status initial">
                                <p><i class="fas fa-info-circle"></i> 请先完成第一步的时间筛选和第二步的字段定义</p>
                                <p>完成后，点击下方的"生成最终核算表"按钮</p>
                            </div>
                            
                            <div id="summaryReadyStatus" class="summary-status ready" style="display: none;">
                                <p><i class="fas fa-check-circle"></i> 已准备就绪！可以生成最终核算表</p>
                                <p>筛选数据: <span id="summaryDataCount">0</span> 行</p>
                                <p>优化特性: 智能索引 + 批量处理</p>
                            </div>
                            
                            <div id="summaryProcessingStatus" class="summary-status processing" style="display: none;">
                                <p><i class="fas fa-spinner fa-spin"></i> 正在生成最终核算表...</p>
                                <p id="summaryProgressText">初始化处理引擎...</p>
                            </div>
                            
                            <div id="summaryErrorStatus" class="summary-status error" style="display: none;">
                                <p><i class="fas fa-exclamation-circle"></i> 生成核算表时出现错误</p>
                                <p id="summaryErrorMessage"></p>
                            </div>
                        </div>
                        
                        <!-- 手动输入区域 -->
                        <div class="manual-input-section" id="manualInputSection" style="display: none;">
                            <h4 style="color: #856404; margin-bottom: 15px;">
                                <i class="fas fa-keyboard"></i> 手动输入补充数据
                            </h4>
                            
                            <!-- 物流费手动输入 -->
                            <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                                <h5 style="color: #2c3e50; margin-bottom: 10px;">
                                    <i class="fas fa-truck"></i> 物流费补充数据
                                </h5>
                                <div class="manual-input-row">
                                    <div class="manual-input-item">
                                        <label for="headLogisticsFee">头程物流费总额（$）</label>
                                        <input type="number" id="headLogisticsFee" placeholder="请输入当月头程物流费总额" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 广告费手动输入 -->
                            <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                                <h5 style="color: #2c3e50; margin-bottom: 10px;">
                                    <i class="fas fa-ad"></i> 广告费补充数据
                                </h5>
                                <div class="manual-input-row">
                                    <div class="manual-input-item">
                                        <label for="additionalAdvertisingFee">额外广告费（$）</label>
                                        <input type="number" id="additionalAdvertisingFee" placeholder="请输入当月额外广告费" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 产品成本手动输入 -->
                            <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                                <h5 style="color: #2c3e50; margin-bottom: 10px;">
                                    <i class="fas fa-box"></i> 产品成本补充数据
                                </h5>
                                <div class="manual-input-row">
                                    <div class="manual-input-item">
                                        <label for="additionalProductCost">额外产品成本（$）</label>
                                        <input type="number" id="additionalProductCost" placeholder="请输入当月额外产品成本" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="summaryControls" style="display: none; margin-top: 20px;">
                            <div class="summary-controls">
                                <button class="tool-btn" onclick="ui.generateFinalSummary()" style="padding: 10px 20px; background: #9b59b6; color: white;">
                                    <i class="fas fa-calculator"></i> 生成最终核算表
                                </button>
                                <button class="tool-btn" onclick="ui.exportFinalSummary()" style="padding: 10px 20px;">
                                    <i class="fas fa-download"></i> 导出核算表
                                </button>
                                <button class="tool-btn" onclick="ui.previewFinalSummary()" style="padding: 10px 20px;">
                                    <i class="fas fa-eye"></i> 预览核算表
                                </button>
                            </div>
                        </div>
                        
                        <!-- 最终核算结果显示区域 -->
                        <div id="finalSummaryResults" style="margin-top: 30px; display: none;"></div>
                    </div>
                    
                    <!-- 一键完成全流程 -->
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="tool-btn" onclick="ui.processCompleteSummaryWorkflow()" style="padding: 12px 30px; background: #e74c3c; color: white; font-size: 1.1rem;">
                            <i class="fas fa-bolt"></i> 一键完成全流程（优化版）
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 性能监控面板 -->
            <div id="performancePanel" class="content-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-tachometer-alt"></i> 性能监控</h2>
                </div>
                
                <div style="padding: 30px;">
                    <div class="info-panel">
                        <h4><i class="fas fa-chart-line"></i> 系统性能指标</h4>
                        <p>监控数据处理系统的各项性能指标</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                        <!-- 内存使用情况 -->
                        <div class="metric-card">
                            <div class="metric-header">
                                <i class="fas fa-memory" style="color: #3498db;"></i>
                                <h3>内存使用</h3>
                            </div>
                            <div class="metric-body">
                                <div id="memoryChart" style="height: 200px;"></div>
                                <div id="memoryStats" style="margin-top: 15px;">
                                    <div>已用内存: <span id="usedMemory">--</span> MB</div>
                                    <div>总内存: <span id="totalMemory">--</span> MB</div>
                                    <div>使用率: <span id="memoryUsagePercent">--</span>%</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 处理速度 -->
                        <div class="metric-card">
                            <div class="metric-header">
                                <i class="fas fa-tachometer-alt" style="color: #27ae60;"></i>
                                <h3>处理速度</h3>
                            </div>
                            <div class="metric-body">
                                <div id="speedChart" style="height: 200px;"></div>
                                <div id="speedStats" style="margin-top: 15px;">
                                    <div>解析速度: <span id="parseSpeed">--</span> 行/秒</div>
                                    <div>映射速度: <span id="mappingSpeed">--</span> 行/秒</div>
                                    <div>优化倍数: <span id="optimizationRatio">--</span> 倍</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 索引性能 -->
                        <div class="metric-card">
                            <div class="metric-header">
                                <i class="fas fa-search" style="color: #9b59b6;"></i>
                                <h3>索引性能</h3>
                            </div>
                            <div class="metric-body">
                                <div id="indexChart" style="height: 200px;"></div>
                                <div id="indexStats" style="margin-top: 15px;">
                                    <div>索引数量: <span id="indexCount">--</span></div>
                                    <div>查找速度: <span id="lookupSpeed">--</span> μs/次</div>
                                    <div>命中率: <span id="hitRate">--</span>%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 性能优化建议 -->
                    <div style="margin-top: 30px; background: #e8f4fc; padding: 20px; border-radius: 8px;">
                        <h4><i class="fas fa-lightbulb"></i> 性能优化建议</h4>
                        <div style="margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div class="suggestion">
                                    <strong>⚡ 启用流式处理</strong>
                                    <p>大文件分块读取，避免内存溢出</p>
                                </div>
                                <div class="suggestion">
                                    <strong>🔍 使用智能索引</strong>
                                    <p>建立哈希索引，提升查找速度100倍</p>
                                </div>
                                <div class="suggestion">
                                    <strong>🔄 启用虚拟滚动</strong>
                                    <p>只渲染可见区域，减少DOM操作</p>
                                </div>
                                <div class="suggestion">
                                    <strong>🧹 压缩数据存储</strong>
                                    <p>使用TypedArray存储数字，减少内存占用</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 文件上传输入 -->
    <input type="file" id="fileInput" multiple style="display: none;" 
           accept=".csv,.xlsx,.xls,.zip">

    <!-- 引入第三方库 -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 引入Chart.js用于性能图表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 引入优化后的核心模块 -->
    <script src="js/core/DataStorage.js"></script>
    <script src="js/core/FileProcessor.js"></script>
    <script src="js/core/DataProcessor.js"></script>
    <script src="js/ui/VirtualScroll.js"></script>
    <script src="js/ui/UIManager.js"></script>
    
    <!-- 主应用入口 -->
    <script src="js/app.js"></script>
</body>
</html>