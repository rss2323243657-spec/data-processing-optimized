<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专业数据核算系统 - 优化版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            background: #f5f7fa;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .logo {
            padding: 30px 20px;
            border-bottom: 1px solid #eee;
        }

        .logo h1 {
            font-size: 1.5rem;
            color: #2c3e50;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }

        .nav-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: #f8f9fa;
        }

        .nav-item.active {
            background: #e8f4fc;
            border-left-color: #3498db;
            color: #3498db;
        }

        .nav-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .badge {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: auto;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            overflow-y: auto;
        }

        .content-panel {
            display: none;
            padding: 20px;
            min-height: 100vh;
        }

        .content-panel.active {
            display: block;
        }

        .panel-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .panel-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
        }

        /* 上传区域 */
        .upload-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .upload-box {
            background: white;
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 50px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-box:hover {
            background: #f0f7ff;
            border-color: #2980b9;
        }

        .upload-icon {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-bar div {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s;
        }

        /* 表格管理 */
        .table-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .table-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .table-card:hover {
            transform: translateY(-5px);
        }

        /* 工具按钮 */
        .tool-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .tool-btn:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .tool-btn.primary {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        /* 状态消息 */
        .status-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }

        .status-message.success {
            border-left: 4px solid #27ae60;
            background: #d4edda;
        }

        .status-message.error {
            border-left: 4px solid #e74c3c;
            background: #f8d7da;
        }

        .status-message.info {
            border-left: 4px solid #3498db;
            background: #d1ecf1;
        }

        /* 模态框 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* 加载动画 */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            flex-direction: column;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 数据预览表格 */
        .data-preview {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .data-preview th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
        }

        .data-preview td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }

        .data-preview tr:hover {
            background: #f5f5f5;
        }

        /* 流程步骤 */
        .process-step {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        /* 信息面板 */
        .info-panel {
            background: #e8f4fc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-panel h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .table-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div id="loaderMessage" style="color: white; margin-top: 20px; text-align: center;">
            正在初始化系统...
        </div>
    </div>

    <!-- 状态提示 -->
    <div id="statusMessage" class="status-message"></div>

    <!-- 主应用容器 -->
    <div class="app-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-calculator"></i> 数据核算系统</h1>
                <small style="color: #3498db; font-size: 0.8rem;">优化稳定版</small>
            </div>
            
            <div class="nav-menu">
                <div class="nav-item active" onclick="showPanel('upload')">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>数据上传</span>
                    <span id="uploadBadge" class="badge">新</span>
                </div>
                <div class="nav-item" onclick="showPanel('tables')">
                    <i class="fas fa-table"></i>
                    <span>数据表管理</span>
                    <span id="tableCount" class="badge">0</span>
                </div>
                <div class="nav-item" onclick="showPanel('process')">
                    <i class="fas fa-cogs"></i>
                    <span>数据处理</span>
                </div>
                <div class="nav-item" onclick="showPanel('merge')">
                    <i class="fas fa-object-group"></i>
                    <span>账单汇总</span>
                </div>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 上传面板 -->
            <div id="uploadPanel" class="content-panel active">
                <div class="panel-header">
                    <h2><i class="fas fa-cloud-upload-alt"></i> 数据上传</h2>
                    <p style="color: #666; margin-top: 10px;">支持 .xlsx, .xls, .csv 格式文件，文件不会被分割</p>
                </div>
                
                <div class="upload-container">
                    <!-- 文件上传区域 -->
                    <div class="upload-box" id="uploadDropArea" onclick="document.getElementById('fileInput').click();">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <h3>点击或拖放文件到此处</h3>
                            <p>支持 .xlsx, .xls, .csv 格式 - 完整文件处理，不会分割</p>
                            <div id="progressContainer" style="display: none;">
                                <div class="progress-bar">
                                    <div id="progressBar"></div>
                                </div>
                                <div id="progressDetails" style="margin-top: 10px; color: #666;">
                                    <span id="progressText">正在解析...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 上传按钮 -->
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="tool-btn primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open"></i> 选择文件
                        </button>
                        <button class="tool-btn" onclick="ui.clearAllTables()" style="margin-left: 10px;">
                            <i class="fas fa-trash"></i> 清空所有
                        </button>
                    </div>
                    
                    <!-- 当前文件信息 -->
                    <div id="fileInfo" style="margin-top: 30px; display: none;">
                        <h3><i class="fas fa-file-alt"></i> 已上传文件</h3>
                        <div id="fileList" style="margin-top: 10px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- 数据表管理面板 -->
            <div id="tablesPanel" class="content-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-table"></i> 数据表管理</h2>
                    <p style="color: #666; margin-top: 10px;">管理已上传的所有数据表格</p>
                </div>
                
                <div style="padding: 20px;">
                    <div id="tableListContainer" class="table-list">
                        <!-- 表格卡片动态生成 -->
                        <div style="text-align: center; padding: 50px; color: #999; grid-column: 1 / -1;">
                            <i class="fas fa-table" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>暂无数据表，请先上传文件</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据处理面板 -->
            <div id="processPanel" class="content-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-cogs"></i> 数据处理</h2>
                </div>
                
                <div style="padding: 20px;">
                    <!-- 第一步：选择要处理的表格 -->
                    <div class="process-step">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <h3>选择处理表格</h3>
                        </div>
                        <p>选择要处理的数据表格，系统会进行智能合并和核算</p>
                        
                        <div style="margin: 20px 0;">
                            <label for="processTableSelect">选择表格：</label>
                            <select id="processTableSelect" style="width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">请选择要处理的数据表</option>
                            </select>
                        </div>
                        
                        <div id="processTableInfo" style="display: none;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 15px;">
                                <h4><i class="fas fa-info-circle"></i> 表格信息</h4>
                                <p>行数: <span id="tableRowCount">0</span></p>
                                <p>列数: <span id="tableColumnCount">0</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第二步：数据处理选项 -->
                    <div class="process-step" style="border-left-color: #27ae60;">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <h3>数据处理选项</h3>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="removeDuplicates" checked>
                                    移除重复数据
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="fillEmptyValues" checked>
                                    填充空值
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="formatNumbers" checked>
                                    格式化数字
                                </label>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="tool-btn primary" onclick="ui.processSelectedTable()">
                                <i class="fas fa-play"></i> 开始处理
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 账单汇总面板 -->
            <div id="mergePanel" class="content-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-object-group"></i> 账单汇总与核算</h2>
                </div>
                
                <div style="padding: 20px;">
                    <div class="process-step" style="border-left-color: #9b59b6;">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <h3>账单汇总</h3>
                        </div>
                        
                        <p>选择已处理的表格进行汇总分析</p>
                        
                        <div style="margin: 20px 0;">
                            <label for="summaryTableSelect">选择处理后的表格：</label>
                            <select id="summaryTableSelect" style="width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">请选择已处理的数据表</option>
                            </select>
                        </div>
                        
                        <div id="summaryControls" style="display: none; text-align: center; margin-top: 30px;">
                            <button class="tool-btn primary" onclick="ui.generateSummary()">
                                <i class="fas fa-calculator"></i> 生成汇总报表
                            </button>
                            <button class="tool-btn" onclick="ui.exportSummary()" style="margin-left: 10px;">
                                <i class="fas fa-download"></i> 导出报表
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 文件上传输入 -->
    <input type="file" id="fileInput" multiple style="display: none;" 
           accept=".csv,.xlsx,.xls">

    <!-- 引入XLSX库 -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <script>
        // 全局变量
        const appState = {
            tables: [],
            currentPanel: 'upload',
            isLoading: false
        };

        // UI管理器 - 修复版
        const ui = {
            // 显示加载动画
            showLoader: function(message = '正在处理...') {
                document.getElementById('loader').style.display = 'flex';
                document.getElementById('loaderMessage').textContent = message;
            },
            
            // 隐藏加载动画
            hideLoader: function() {
                document.getElementById('loader').style.display = 'none';
            },
            
            // 显示状态消息
            showStatus: function(message, type = 'info', duration = 3000) {
                const statusEl = document.getElementById('statusMessage');
                statusEl.textContent = message;
                statusEl.className = 'status-message ' + type;
                statusEl.style.display = 'block';
                
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, duration);
            },
            
            // 更新所有面板
            updateAllPanels: function() {
                this.updateTableManagementPanel();
                this.updateProcessPanel();
                this.updateSummaryPanel();
            },
            
            // 更新表格管理面板
            updateTableManagementPanel: function() {
                const container = document.getElementById('tableListContainer');
                if (!container) return;
                
                // 更新表格数量
                const tableCount = document.getElementById('tableCount');
                if (tableCount) {
                    tableCount.textContent = appState.tables.length;
                }
                
                // 如果没有表格
                if (appState.tables.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #999; grid-column: 1 / -1;">
                            <i class="fas fa-table" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>暂无数据表，请先上传文件</p>
                        </div>
                    `;
                    return;
                }
                
                // 更新表格卡片
                container.innerHTML = '';
                appState.tables.forEach((table, index) => {
                    const card = document.createElement('div');
                    card.className = 'table-card';
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h4 style="color: #2c3e50; margin: 0;">${table.name}</h4>
                            <span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.85rem;">
                                ${table.data.length}行
                            </span>
                        </div>
                        <div style="color: #666; margin-bottom: 15px;">
                            <p><i class="fas fa-columns"></i> 列数: ${table.columns ? table.columns.length : '未知'}</p>
                            <p><i class="fas fa-calendar"></i> 上传时间: ${table.uploadTime || new Date().toLocaleString()}</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="tool-btn" onclick="ui.previewTable(${index})" style="flex: 1; padding: 8px;">
                                <i class="fas fa-eye"></i> 预览
                            </button>
                            <button class="tool-btn" onclick="ui.exportTable(${index})" style="flex: 1; padding: 8px;">
                                <i class="fas fa-download"></i> 导出
                            </button>
                            <button class="tool-btn" onclick="ui.deleteTable(${index})" style="flex: 1; padding: 8px; color: #e74c3c;">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            },
            
            // 更新处理面板
            updateProcessPanel: function() {
                const select = document.getElementById('processTableSelect');
                if (!select) return;
                
                select.innerHTML = '<option value="">请选择要处理的数据表</option>';
                appState.tables.forEach((table, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${table.name} (${table.data.length}行)`;
                    select.appendChild(option);
                });
                
                // 监听选择变化
                select.onchange = function() {
                    const index = parseInt(this.value);
                    if (!isNaN(index) && appState.tables[index]) {
                        const table = appState.tables[index];
                        document.getElementById('processTableInfo').style.display = 'block';
                        document.getElementById('tableRowCount').textContent = table.data.length;
                        document.getElementById('tableColumnCount').textContent = table.columns ? table.columns.length : '未知';
                    } else {
                        document.getElementById('processTableInfo').style.display = 'none';
                    }
                };
            },
            
            // 更新汇总面板
            updateSummaryPanel: function() {
                const select = document.getElementById('summaryTableSelect');
                if (!select) return;
                
                select.innerHTML = '<option value="">请选择已处理的数据表</option>';
                appState.tables.forEach((table, index) => {
                    if (table.processed) {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `${table.name} (已处理)`;
                        select.appendChild(option);
                    }
                });
                
                select.onchange = function() {
                    document.getElementById('summaryControls').style.display = 
                        this.value ? 'block' : 'none';
                };
            },
            
            // 预览表格数据
            previewTable: function(index) {
                const table = appState.tables[index];
                if (!table) return;
                
                // 创建模态框
                const modal = this.createModal('数据预览 - ' + table.name);
                
                // 显示前10行数据
                let html = `
                    <div style="margin-bottom: 20px; color: #666;">
                        <p><strong>表格信息：</strong> ${table.data.length}行 × ${table.columns ? table.columns.length : '未知'}列</p>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-preview">
                            <thead>
                                <tr>
                `;
                
                // 表头
                if (table.columns && table.columns.length > 0) {
                    table.columns.forEach(col => {
                        html += `<th>${col}</th>`;
                    });
                } else if (table.data.length > 0) {
                    Object.keys(table.data[0]).forEach(key => {
                        html += `<th>${key}</th>`;
                    });
                }
                
                html += `</tr></thead><tbody>`;
                
                // 数据行（最多显示50行）
                const maxRows = Math.min(50, table.data.length);
                for (let i = 0; i < maxRows; i++) {
                    html += '<tr>';
                    const row = table.data[i];
                    
                    if (table.columns && table.columns.length > 0) {
                        table.columns.forEach(col => {
                            html += `<td>${row[col] || ''}</td>`;
                        });
                    } else {
                        Object.values(row).forEach(val => {
                            html += `<td>${val || ''}</td>`;
                        });
                    }
                    
                    html += '</tr>';
                }
                
                html += `</tbody></table>`;
                
                if (table.data.length > maxRows) {
                    html += `<p style="margin-top: 15px; color: #999;">仅显示前${maxRows}行，共${table.data.length}行数据</p>`;
                }
                
                modal.body.innerHTML = html;
                this.showModal();
            },
            
            // 创建模态框
            createModal: function(title) {
                let overlay = document.getElementById('modalOverlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';
                    overlay.id = 'modalOverlay';
                    overlay.onclick = function(e) {
                        if (e.target === overlay) {
                            ui.hideModal();
                        }
                    };
                    
                    const modal = document.createElement('div');
                    modal.className = 'modal-content';
                    modal.id = 'modalContent';
                    
                    const header = document.createElement('div');
                    header.className = 'modal-header';
                    header.innerHTML = `
                        <h3 id="modalTitle"></h3>
                        <button onclick="ui.hideModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    const body = document.createElement('div');
                    body.className = 'modal-body';
                    body.id = 'modalBody';
                    
                    modal.appendChild(header);
                    modal.appendChild(body);
                    overlay.appendChild(modal);
                    document.body.appendChild(overlay);
                }
                
                document.getElementById('modalTitle').textContent = title;
                return {
                    body: document.getElementById('modalBody'),
                    show: () => overlay.style.display = 'flex',
                    hide: () => overlay.style.display = 'none'
                };
            },
            
            // 显示模态框
            showModal: function() {
                document.getElementById('modalOverlay').style.display = 'flex';
            },
            
            // 隐藏模态框
            hideModal: function() {
                document.getElementById('modalOverlay').style.display = 'none';
            },
            
            // 导出表格
            exportTable: function(index) {
                const table = appState.tables[index];
                if (!table) return;
                
                try {
                    // 创建工作表
                    const ws = XLSX.utils.json_to_sheet(table.data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, table.name);
                    
                    // 导出文件
                    XLSX.writeFile(wb, `${table.name}_导出.xlsx`);
                    this.showStatus('表格导出成功', 'success');
                } catch (error) {
                    console.error('导出失败:', error);
                    this.showStatus('导出失败: ' + error.message, 'error');
                }
            },
            
            // 删除表格
            deleteTable: function(index) {
                if (confirm('确定要删除这个表格吗？')) {
                    appState.tables.splice(index, 1);
                    this.updateAllPanels();
                    this.showStatus('表格已删除', 'success');
                }
            },
            
            // 清空所有表格
            clearAllTables: function() {
                if (appState.tables.length === 0) {
                    this.showStatus('没有可清空的表格', 'info');
                    return;
                }
                
                if (confirm('确定要清空所有表格吗？此操作不可恢复。')) {
                    appState.tables = [];
                    this.updateAllPanels();
                    this.showStatus('所有表格已清空', 'success');
                }
            },
            
            // 处理选中的表格
            processSelectedTable: function() {
                const select = document.getElementById('processTableSelect');
                const index = parseInt(select.value);
                
                if (isNaN(index) || !appState.tables[index]) {
                    this.showStatus('请先选择要处理的表格', 'error');
                    return;
                }
                
                const table = appState.tables[index];
                this.showLoader('正在处理表格...');
                
                // 模拟处理过程
                setTimeout(() => {
                    // 标记为已处理
                    table.processed = true;
                    
                    // 简单处理：添加处理时间戳
                    table.processTime = new Date().toISOString();
                    
                    this.hideLoader();
                    this.showStatus('表格处理完成', 'success');
                    this.updateAllPanels();
                }, 1500);
            },
            
            // 生成汇总报表
            generateSummary: function() {
                const select = document.getElementById('summaryTableSelect');
                const index = parseInt(select.value);
                
                if (isNaN(index) || !appState.tables[index]) {
                    this.showStatus('请先选择要汇总的表格', 'error');
                    return;
                }
                
                const table = appState.tables[index];
                this.showLoader('正在生成汇总报表...');
                
                // 模拟汇总处理
                setTimeout(() => {
                    const modal = this.createModal('汇总报表 - ' + table.name);
                    
                    // 简单的汇总统计
                    let html = `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">表格基本信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                    <p style="color: #666; margin: 0; font-size: 0.9rem;">总行数</p>
                                    <p style="font-size: 1.5rem; font-weight: bold; color: #3498db; margin: 5px 0 0 0;">${table.data.length}</p>
                                </div>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                    <p style="color: #666; margin: 0; font-size: 0.9rem;">列数</p>
                                    <p style="font-size: 1.5rem; font-weight: bold; color: #27ae60; margin: 5px 0 0 0;">${table.columns ? table.columns.length : '未知'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    modal.body.innerHTML = html;
                    this.hideLoader();
                    this.showModal();
                    this.showStatus('汇总报表生成完成', 'success');
                }, 2000);
            },
            
            // 导出汇总报表
            exportSummary: function() {
                this.showStatus('汇总报表导出功能开发中...', 'info');
            }
        };

        // 文件处理器
        const fileProcessor = {
            // 处理上传的文件
            handleFiles: async function(files) {
                ui.showLoader('正在读取文件...');
                
                for (let file of files) {
                    try {
                        await this.processSingleFile(file);
                    } catch (error) {
                        console.error('处理文件失败:', error);
                        ui.showStatus(`处理文件 ${file.name} 失败: ${error.message}`, 'error');
                    }
                }
                
                ui.hideLoader();
                ui.showStatus('所有文件处理完成', 'success');
                ui.updateAllPanels();
                showPanel('tables');
            },
            
            // 处理单个文件
            processSingleFile: function(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            // 读取Excel文件
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            // 处理每个工作表
                            workbook.SheetNames.forEach(sheetName => {
                                const worksheet = workbook.Sheets[sheetName];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                                
                                if (jsonData.length > 0) {
                                    // 获取列名
                                    const columns = [];
                                    if (jsonData[0]) {
                                        columns.push(...Object.keys(jsonData[0]));
                                    }
                                    
                                    // 添加到应用状态
                                    appState.tables.push({
                                        name: `${file.name} - ${sheetName}`,
                                        data: jsonData,
                                        columns: columns,
                                        uploadTime: new Date().toLocaleString(),
                                        fileName: file.name,
                                        sheetName: sheetName
                                    });
                                    
                                    // 更新进度显示
                                    document.getElementById('progressText').textContent = 
                                        `已读取: ${jsonData.length}行数据`;
                                }
                            });
                            
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            },
            
            // 处理CSV文件
            handleCSVFile: function(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const csvText = e.target.result;
                            const lines = csvText.split('\n');
                            
                            if (lines.length < 2) {
                                reject(new Error('CSV文件内容为空'));
                                return;
                            }
                            
                            // 解析CSV
                            const headers = lines[0].split(',').map(h => h.trim());
                            const data = [];
                            
                            for (let i = 1; i < lines.length; i++) {
                                if (lines[i].trim()) {
                                    const values = lines[i].split(',');
                                    const row = {};
                                    headers.forEach((header, index) => {
                                        row[header] = values[index] ? values[index].trim() : '';
                                    });
                                    data.push(row);
                                }
                            }
                            
                            // 添加到应用状态
                            appState.tables.push({
                                name: file.name,
                                data: data,
                                columns: headers,
                                uploadTime: new Date().toLocaleString(),
                                fileName: file.name,
                                isCSV: true
                            });
                            
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
        };

        // 初始化应用
        function initApp() {
            console.log('数据核算系统初始化...');
            
            // 绑定文件上传事件
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // 初始化文件拖放
            initFileDrop();
            
            // 隐藏加载动画
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                ui.showStatus('系统初始化完成', 'success');
            }, 1000);
        }

        // 处理文件选择
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            // 显示文件信息
            const fileInfo = document.getElementById('fileInfo');
            const fileList = document.getElementById('fileList');
            
            fileList.innerHTML = '';
            for (let file of files) {
                fileList.innerHTML += `
                    <div style="background: white; padding: 10px; margin: 5px 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <span><i class="fas fa-file"></i> ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                `;
            }
            fileInfo.style.display = 'block';
            
            // 处理文件
            fileProcessor.handleFiles(files).then(() => {
                // 清空文件输入
                event.target.value = '';
            }).catch(error => {
                ui.showStatus('文件处理失败: ' + error.message, 'error');
            });
        }

        // 初始化文件拖放
        function initFileDrop() {
            const dropArea = document.getElementById('uploadDropArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.style.borderColor = '#2980b9';
                dropArea.style.background = '#f0f7ff';
            }
            
            function unhighlight() {
                dropArea.style.borderColor = '#3498db';
                dropArea.style.background = 'white';
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    // 显示文件信息
                    const fileInfo = document.getElementById('fileInfo');
                    const fileList = document.getElementById('fileList');
                    
                    fileList.innerHTML = '';
                    for (let file of files) {
                        fileList.innerHTML += `
                            <div style="background: white; padding: 10px; margin: 5px 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                                <span><i class="fas fa-file"></i> ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                            </div>
                        `;
                    }
                    fileInfo.style.display = 'block';
                    
                    // 处理文件
                    fileProcessor.handleFiles(files);
                }
            }
        }

        // 切换面板
        function showPanel(panelId) {
            // 更新导航项
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelector(`.nav-item[onclick*="'${panelId}'"]`).classList.add('active');
            
            // 显示对应面板
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            document.getElementById(panelId + 'Panel').classList.add('active');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
